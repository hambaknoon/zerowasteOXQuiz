<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3ë¬¸ì œ í€´ì¦ˆ ëˆ„ì  í†µê³„ ë¶„ì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        /* Chart Container Styling for Aspect Ratio */
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">ğŸ“Š 3ë¬¸ì œ í€´ì¦ˆ ëˆ„ì  í†µê³„ ë¶„ì„</h1>
            <p class="text-lg text-gray-600">ì»¬ë ‰ì…˜: **3quiz_results**ì˜ ëˆ„ì ëœ ì°¸ê°€ ë°ì´í„° ë° ì •ë‹µë¥ ì„ ë¶„ì„í•©ë‹ˆë‹¤.</p>
        </header>

        <section id="statistics-section" class="bg-white p-6 rounded-lg shadow-xl mb-10">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">í†µê³„ ìš”ì•½ ë° ë¶„í¬</h2>
            
            <div id="loading-message" class="text-center p-10 text-xl font-medium text-indigo-500">
                <p>ë°ì´í„°ë¥¼ Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. â³</p>
            </div>
            
            <div id="stats-content" class="hidden">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 items-center">
                    <div class="col-span-1 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-xl font-medium mb-3 text-gray-700">ì°¸ê°€ì ì—°ë ¹ë³„ ë¶„í¬</h3>
                        <div class="chart-container">
                            <canvas id="age-pie-chart"></canvas>
                        </div>
                    </div>
                    
                    <div id="summary-cards" class="col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        </div>
                </div>

                <div id="age-accuracy-display" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-10">
                    </div>
                
                <h2 class="text-2xl font-bold mb-6 mt-10 text-gray-800">ì‹œê°„ëŒ€ë³„ ì°¸ê°€ì ë¶„ì„</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                        <h3 class="text-xl font-medium mb-3 text-gray-700">ğŸ“… ì¼ë³„ ì°¸ê°€ì ìˆ˜ (ìµœê·¼ 30ì¼)</h3>
                        <div class="chart-container">
                            <canvas id="daily-bar-chart"></canvas>
                        </div>
                    </div>

                    <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                        <h3 class="text-xl font-medium mb-3 text-gray-700">ğŸ—“ï¸ ì›”ë³„ ì°¸ê°€ì ìˆ˜ (ëˆ„ì )</h3>
                        <div class="chart-container">
                            <canvas id="monthly-bar-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="raw-data-section" class="bg-white p-6 rounded-lg shadow-xl mb-10">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">ë¡œìš° ë°ì´í„° ë° íŒŒì¼</h2>

            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mb-6">
                <button id="back-to-quiz-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded transition duration-200">
                    â¬…ï¸ í€´ì¦ˆ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-200" disabled>
                    â¬‡ï¸ ë¡œìš° ë°ì´í„° CSV ë‹¤ìš´ë¡œë“œ
                </button>
            </div>

            <div id="raw-data-table-container" class="overflow-x-auto border rounded-lg">
                </div>
        </section>
        
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
   <script type="module">
    // -------------------------------------------------------------------------
    // 1. Firebase ì„¤ì • ë° SDK Import
    // -------------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB-gGpaopmgAp0JAhhj7ghgB-0wbGeTWlE",
        authDomain: "moupcycle-3ae84.firebaseapp.com",
        projectId: "moupcycle-3ae84",
        storageBucket: "moupcycle-3ae84.firebasestorage.app",
        messagingSenderId: "808583858427",
        appId: "1:808583858427:web:36f2d7a75ec45bf4bf885e",
        measurementId: "G-ZDBL0Y0RX4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // â­ 3ë¬¸ì œ í€´ì¦ˆ ì»¬ë ‰ì…˜ ì‚¬ìš©
    const RESULTS_COLLECTION = '3quiz_results';
    
    // -------------------------------------------------------------------------
    // 2. Firebase ë°ì´í„° ë¡œë”© í•¨ìˆ˜ (ë¹„ë™ê¸°)
    // -------------------------------------------------------------------------
    async function fetchResultsFromFirestore() {
        try {
            // ì‹œê°„ ì—­ìˆœìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
            const q = query(collection(db, RESULTS_COLLECTION), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            const results = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                data.id = doc.id;
                // Firebase Timestamp ê°ì²´ë¥¼ JavaScript Date ê°ì²´ ë˜ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
                if (data.timestamp && data.timestamp instanceof Timestamp) {
                     data.timestamp = data.timestamp.toDate();
                }
                if (data.correctLog && Array.isArray(data.correctLog)) {
                    results.push(data);
                }
            });
            return results;
        } catch (error) {
            console.error("Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            document.getElementById('loading-message').innerHTML = `
                <p class='text-red-500 p-4'>Firestore ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë³´ì•ˆ ê·œì¹™ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ)</p>
                <p class='text-sm text-gray-500'>ì˜¤ë¥˜: ${error.message}</p>
            `;
            document.getElementById('stats-content').classList.add('hidden');
            return [];
        }
    }

    // -------------------------------------------------------------------------
    // 3. í†µê³„ ë¶„ì„ ë° í‘œì‹œ í•¨ìˆ˜
    // -------------------------------------------------------------------------

    /**
     * ì „ì²´ í€´ì¦ˆ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ í†µê³„ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
     */
    function analyzeResults(results) {
        const stats = {
            totalParticipants: results.length,
            ageGroupCounts: { elementary: 0, adolescent: 0, adult: 0 },
            ageGroupScores: { 
                elementary: { totalScore: 0, totalQuestions: 0 }, 
                adolescent: { totalScore: 0, totalQuestions: 0 }, 
                adult: { totalScore: 0, totalQuestions: 0 } 
            },
            totalScore: 0,
            totalQuestions: 0 
        };
        const ageGroups = ['elementary', 'adolescent', 'adult'];

        results.forEach(res => {
            const age = res.ageGroup;
            if (!ageGroups.includes(age)) return;

            stats.ageGroupCounts[age]++;
            stats.totalScore += res.score || 0;
            
            const currentQuestions = 3; 
            stats.totalQuestions += currentQuestions;
            
            stats.ageGroupScores[age].totalScore += res.score || 0;
            stats.ageGroupScores[age].totalQuestions += currentQuestions;
        });

        stats.overallAccuracy = stats.totalQuestions > 0 ? ((stats.totalScore / stats.totalQuestions) * 100).toFixed(1) : 0;
        
        ageGroups.forEach(age => {
            const data = stats.ageGroupScores[age];
            data.accuracy = data.totalQuestions > 0 ? ((data.totalScore / data.totalQuestions) * 100).toFixed(1) : 0;
        });

        return stats;
    }

    /**
     * í€´ì¦ˆ ê²°ê³¼ë¥¼ ì‹œê°„ë³„ë¡œ ë¶„ì„í•˜ì—¬ ì¼ë³„, ì›”ë³„ ì°¸ê°€ì ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
     */
    function analyzeByTime(results) {
        const dailyCounts = {};
        const monthlyCounts = {};

        results.forEach(res => {
            const timestamp = res.timestamp || new Date();
            
            // Daily Key (YYYY-MM-DD)
            const dateKey = timestamp.toISOString().split('T')[0];
            dailyCounts[dateKey] = (dailyCounts[dateKey] || 0) + 1;

            // Monthly Key (YYYY-MM)
            const monthKey = dateKey.substring(0, 7);
            monthlyCounts[monthKey] = (monthlyCounts[monthKey] || 0) + 1;
        });

        return { dailyCounts, monthlyCounts };
    }
    
    // -------------------------------------------------------------------------
    // 4. ì‹œê°í™” í•¨ìˆ˜ (ì´ì „ ë‹µë³€ê³¼ ë™ì¼)
    // -------------------------------------------------------------------------

    function displayPieChart(analysis) {
        const total = analysis.totalParticipants;
        const counts = [
            analysis.ageGroupCounts.elementary, 
            analysis.ageGroupCounts.adolescent, 
            analysis.ageGroupCounts.adult
        ];

        if (window.agePieChartInstance) {
            window.agePieChartInstance.destroy();
        }

        const ctx = document.getElementById('age-pie-chart').getContext('2d');
        window.agePieChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['ì´ˆë“±', 'ì²­ì†Œë…„', 'ì„±ì¸'],
                datasets: [{
                    data: counts,
                    backgroundColor: ['#FBBF24', '#22D3EE', '#F87171'], 
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const rawValue = context.raw;
                                const percentage = total > 0 ? ((rawValue / total) * 100).toFixed(1) : 0;
                                return `${context.label}: ${rawValue}ëª… (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function displaySummary(analysis) {
        const cardsContainer = document.getElementById('summary-cards');
        cardsContainer.innerHTML = ''; 

        const total = analysis.totalParticipants;

        const createCard = (title, value, color, description = '') => `
            <div class="stats-card bg-white p-4 rounded-lg border-b-4 border-${color}-500 shadow-md">
                <p class="text-sm font-medium text-gray-500">${title}</p>
                <p class="text-2xl font-extrabold text-${color}-600 mt-1">${value}</p>
                ${description ? `<p class="text-xs text-gray-500 mt-1">${description}</p>` : ''}
            </div>
        `;
        
        cardsContainer.innerHTML += createCard('ì´ ì°¸ê°€ íšŸìˆ˜', `${total}íšŒ`, 'indigo');
        cardsContainer.innerHTML += createCard('ì „ì²´ ì •ë‹µë¥ ', `${analysis.overallAccuracy}%`, 'green');
        cardsContainer.innerHTML += createCard('ì´ ë¬¸ì œ ìˆ˜', `${analysis.totalQuestions}ê°œ`, 'blue');
        
        const ageData = analysis.ageGroupScores;
        const ageCardsContainer = document.getElementById('age-accuracy-display');
        ageCardsContainer.innerHTML = '';
        
        const ageCards = [
            { label: 'ì´ˆë“± ì •ë‹µë¥ ', color: 'yellow', acc: ageData.elementary.accuracy },
            { label: 'ì²­ì†Œë…„ ì •ë‹µë¥ ', color: 'cyan', acc: ageData.adolescent.accuracy },
            { label: 'ì„±ì¸ ì •ë‹µë¥ ', color: 'red', acc: ageData.adult.accuracy },
        ];

        ageCards.forEach(card => {
            ageCardsContainer.innerHTML += `
                <div class="stats-card bg-white p-4 rounded-lg border-l-4 border-${card.color}-500 shadow-md">
                    <p class="text-sm font-medium text-gray-500">${card.label}</p>
                    <p class="text-3xl font-extrabold text-${card.color}-600 mt-1">${card.acc}%</p>
                </div>
            `;
        });
    }

    function displayTimeStats(timeStats) {
        const { dailyCounts, monthlyCounts } = timeStats;

        // 1. ì¼ë³„ ì°¨íŠ¸
        const sortedDailyKeys = Object.keys(dailyCounts).sort().slice(-30);
        const dailyData = sortedDailyKeys.map(key => dailyCounts[key]);

        if (window.dailyBarChartInstance) window.dailyBarChartInstance.destroy();
        
        const dailyCtx = document.getElementById('daily-bar-chart').getContext('2d');
        window.dailyBarChartInstance = new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: sortedDailyKeys,
                datasets: [{
                    label: 'ì¼ë³„ ì°¸ê°€ì ìˆ˜',
                    data: dailyData,
                    backgroundColor: '#6366F1',
                    borderColor: '#4F46E5',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'ì°¸ê°€ì ìˆ˜' } },
                    x: { title: { display: true, text: 'ë‚ ì§œ' } }
                },
                plugins: { legend: { display: false } }
            }
        });

        // 2. ì›”ë³„ ì°¨íŠ¸
        const sortedMonthlyKeys = Object.keys(monthlyCounts).sort();
        const monthlyData = sortedMonthlyKeys.map(key => monthlyCounts[key]);

        if (window.monthlyBarChartInstance) window.monthlyBarChartInstance.destroy();

        const monthlyCtx = document.getElementById('monthly-bar-chart').getContext('2d');
        window.monthlyBarChartInstance = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: sortedMonthlyKeys,
                datasets: [{
                    label: 'ì›”ë³„ ì°¸ê°€ì ìˆ˜',
                    data: monthlyData,
                    backgroundColor: '#F97316',
                    borderColor: '#EA580C',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'ì°¸ê°€ì ìˆ˜' } },
                    x: { title: { display: true, text: 'ì›”' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function displayRawDataTable(results) {
        const tableContainer = document.getElementById('raw-data-table-container');
        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID (ë¬¸ì„œ)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì—°ë ¹ëŒ€</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì„¸íŠ¸ Index</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì ìˆ˜</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì •ë‹µ ìƒì„¸</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        [...results].forEach(res => {
            const ageLabel = { elementary: 'ì´ˆë“±', adolescent: 'ì²­ì†Œë…„', adult: 'ì„±ì¸' }[res.ageGroup] || res.ageGroup;
            const timestampValue = res.timestamp ? (res.timestamp instanceof Date ? res.timestamp.getTime() : res.timestamp) : Date.now();
            const formattedDate = new Date(timestampValue).toLocaleString('ko-KR', { 
                year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' 
            });
            const correctDetail = res.correctLog ? res.correctLog.map(c => c ? 'O' : 'X').join('') : 'N/A';

            tableHTML += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-900">${res.id ? res.id.substring(0, 10) + '...' : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ageLabel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${res.quizSetIndex !== undefined ? res.quizSetIndex : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${res.score !== undefined ? res.score : 'N/A'} / 3</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${correctDetail}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
        `;
        tableContainer.innerHTML = tableHTML;
    }

    function exportToCsv(results) {
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        
        const headers = ["ì°¸ê°€ì ID", "ì—°ë ¹ëŒ€", "í€´ì¦ˆ ì„¸íŠ¸ Index", "ì ìˆ˜", "ì´ ë¬¸ì œ ìˆ˜", "ì •ë‹µ ìƒì„¸ (O=ì •ë‹µ, X=ì˜¤ë‹µ)", "ë‚ ì§œ (ISO)"];
        csvContent += headers.join(",") + "\n";
        
        results.forEach(res => {
            const correctDetail = res.correctLog ? res.correctLog.map(c => c ? 'O' : 'X').join('') : 'N/A';
            const dateIso = res.timestamp ? (res.timestamp instanceof Date ? res.timestamp.toISOString() : new Date(res.timestamp).toISOString()) : new Date().toISOString();
            
            const row = [
                `"${res.id || 'N/A'}"`, 
                res.ageGroup,
                res.quizSetIndex !== undefined ? res.quizSetIndex : 'N/A',
                res.score !== undefined ? res.score : 'N/A',
                3, 
                `"${correctDetail}"`, 
                dateIso
            ];
            csvContent += row.map(item => {
                if (typeof item === 'string') {
                    return `"${item.replace(/"/g, '""')}"`;
                }
                return item;
            }).join(",") + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `3quiz_stats_data_${new Date().toISOString().slice(0, 10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // -------------------------------------------------------------------------
    // 5. ì´ˆê¸°í™” ë° ë©”ì¸ ë¡œì§ ì‹¤í–‰ (JSON íŒŒì¼ ë¡œë“œ ë¶€ë¶„ ì œê±°)
    // -------------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('back-to-quiz-btn').addEventListener('click', () => {
            window.location.href = 'zerowasteOXQuiz.html';
        });

        // í€´ì¦ˆ ë°ì´í„° ë¡œë“œ ëŒ€ì‹ , Firebase ê²°ê³¼ ë°ì´í„°ë§Œ ë¡œë“œí•©ë‹ˆë‹¤.
        const results = await fetchResultsFromFirestore();
        
        document.getElementById('loading-message').classList.add('hidden');
        document.getElementById('stats-content').classList.remove('hidden');

        if (results.length === 0) {
            document.getElementById('raw-data-table-container').innerHTML = "<p class='text-gray-500 p-4'>ì €ì¥ëœ í€´ì¦ˆ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í€´ì¦ˆë¥¼ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.</p>";
            document.getElementById('export-csv-btn').disabled = true;
            return;
        }
        
        // 1. ëˆ„ì  í†µê³„ ë¶„ì„ ë° í‘œì‹œ
        const analysis = analyzeResults(results);
        displaySummary(analysis); 
        displayPieChart(analysis); 

        // 2. ì‹œê°„ë³„ í†µê³„ ë¶„ì„ ë° í‘œì‹œ
        const timeStats = analyzeByTime(results);
        displayTimeStats(timeStats);

        // 3. ë¡œìš° ë°ì´í„° í‘œì‹œ ë° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
        displayRawDataTable(results);
        const exportBtn = document.getElementById('export-csv-btn');
        exportBtn.disabled = false;
        exportBtn.addEventListener('click', () => {
            exportToCsv(results);
        });
    });

</script>
</body>
</html>
